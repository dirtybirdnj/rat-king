<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rat-king vs Shapely Benchmark</title>
    <style>
        :root {
            --bg: #1a1a2e;
            --card: #16213e;
            --accent: #e94560;
            --text: #eee;
            --muted: #888;
            --code-bg: #0f0f1a;
            --success: #4ade80;
            --warning: #fbbf24;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            margin: 0;
            padding: 2rem;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1, h2, h3 { color: var(--accent); margin-top: 2rem; }
        h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .subtitle { color: var(--muted); font-size: 1.1rem; margin-bottom: 2rem; }

        .card {
            background: var(--card);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .result-card {
            background: var(--card);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }
        .result-card h3 {
            margin-top: 0;
            color: var(--text);
        }
        .result-value {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        .python .result-value { color: #fbbf24; }
        .rust .result-value { color: #4ade80; }
        .speedup {
            background: linear-gradient(135deg, var(--accent), #ff6b6b);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }
        .speedup-value {
            font-size: 5rem;
            font-weight: bold;
            color: white;
        }
        .speedup-label {
            font-size: 1.5rem;
            color: rgba(255,255,255,0.9);
        }

        pre {
            background: var(--code-bg);
            border-radius: 6px;
            padding: 1rem;
            overflow-x: auto;
            font-size: 0.9rem;
            border: 1px solid #333;
        }
        code {
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        .inline-code {
            background: var(--code-bg);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        th { color: var(--accent); }

        .methodology {
            background: var(--card);
            border-left: 4px solid var(--accent);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
        }

        .steps { counter-reset: step; }
        .step {
            position: relative;
            padding-left: 3rem;
            margin: 1.5rem 0;
        }
        .step::before {
            counter-increment: step;
            content: counter(step);
            position: absolute;
            left: 0;
            width: 2rem;
            height: 2rem;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .warning {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid var(--warning);
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .warning::before {
            content: "⚠️ ";
        }

        .footer {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #333;
            color: var(--muted);
            font-size: 0.9rem;
        }

        a { color: var(--accent); }
    </style>
</head>
<body>
    <div class="container">
        <h1>rat-king vs Python/Shapely</h1>
        <p class="subtitle">Reproducible performance benchmark for SVG fill pattern generation</p>

        <div class="speedup">
            <div class="speedup-value">~200x</div>
            <div class="speedup-label">faster than Python/Shapely</div>
        </div>

        <div class="results-grid">
            <div class="result-card python">
                <h3>Python + Shapely</h3>
                <div class="result-value">~32s</div>
                <div>essex.svg (314 polygons)</div>
                <div style="color: var(--muted)">lines pattern, spacing=2.5</div>
            </div>
            <div class="result-card rust">
                <h3>Rust rat-king</h3>
                <div class="result-value">~159ms</div>
                <div>essex.svg (314 polygons)</div>
                <div style="color: var(--muted)">lines pattern, spacing=2.5</div>
            </div>
        </div>

        <h2>Test Environment</h2>
        <div class="card">
            <table>
                <tr><th>Component</th><th>Version / Spec</th></tr>
                <tr><td>Test File</td><td><code>test_assets/essex.svg</code> - 314 polygons (USGS county boundaries)</td></tr>
                <tr><td>Pattern</td><td><code>lines</code> (parallel hatch fill)</td></tr>
                <tr><td>Spacing</td><td>2.5 units</td></tr>
                <tr><td>Angle</td><td>45 degrees</td></tr>
                <tr><td>Python</td><td>3.11+</td></tr>
                <tr><td>Shapely</td><td>2.0+</td></tr>
                <tr><td>rat-king</td><td>0.1.x (release build)</td></tr>
                <tr><td>Hardware</td><td>Apple M1/M2 or equivalent x86_64</td></tr>
            </table>
        </div>

        <h2>Reproduce the Benchmark</h2>

        <div class="methodology">
            <strong>Methodology:</strong> Both implementations generate parallel hatch lines at 45°,
            clip them to polygon boundaries, and output the result. The Python version uses Shapely's
            <code>intersection()</code> for clipping. rat-king uses a custom ray-casting clipper.
        </div>

        <div class="steps">
            <div class="step">
                <h3>Install Dependencies</h3>
<pre><code># Python dependencies
pip install shapely svgpathtools numpy

# rat-king (from source)
git clone https://github.com/dirtybirdnj/rat-king
cd rat-king/crates
cargo build --release</code></pre>
            </div>

            <div class="step">
                <h3>Save the Python Benchmark Script</h3>
                <p>Save as <code>benchmark_shapely.py</code>:</p>
<pre><code>#!/usr/bin/env python3
"""
Shapely-based hatch fill benchmark.
Generates parallel lines and clips to polygon boundaries.
"""

import time
import math
import sys
from pathlib import Path

try:
    from shapely.geometry import Polygon, LineString, MultiPolygon
    from shapely.ops import unary_union
    from svgpathtools import svg2paths2
    import numpy as np
except ImportError as e:
    print(f"Missing dependency: {e}")
    print("Install with: pip install shapely svgpathtools numpy")
    sys.exit(1)


def svg_to_polygons(svg_path: str) -> list[Polygon]:
    """Extract polygons from SVG file using svgpathtools."""
    paths, attributes, svg_attributes = svg2paths2(svg_path)
    polygons = []

    for path in paths:
        if len(path) == 0:
            continue

        # Sample points along the path
        points = []
        num_samples = max(10, int(path.length() / 2))

        for i in range(num_samples):
            t = i / num_samples
            try:
                pt = path.point(t)
                points.append((pt.real, pt.imag))
            except:
                continue

        if len(points) >= 3:
            try:
                poly = Polygon(points)
                if poly.is_valid and poly.area > 0:
                    polygons.append(poly)
            except:
                continue

    return polygons


def generate_hatch_lines(
    polygon: Polygon,
    spacing: float = 2.5,
    angle_deg: float = 45.0
) -> list[tuple]:
    """
    Generate hatch lines for a polygon using Shapely.
    Returns list of ((x1,y1), (x2,y2)) tuples.
    """
    if not polygon.is_valid or polygon.is_empty:
        return []

    bounds = polygon.bounds  # (minx, miny, maxx, maxy)
    minx, miny, maxx, maxy = bounds

    # Expand bounds to account for rotation
    cx, cy = (minx + maxx) / 2, (miny + maxy) / 2
    diagonal = math.sqrt((maxx - minx)**2 + (maxy - miny)**2)

    # Generate parallel lines
    angle_rad = math.radians(angle_deg)
    cos_a, sin_a = math.cos(angle_rad), math.sin(angle_rad)

    lines = []

    # Line direction perpendicular to angle
    dx, dy = cos_a, sin_a
    # Step direction (perpendicular to line direction)
    step_x, step_y = -sin_a * spacing, cos_a * spacing

    # Number of lines needed
    num_lines = int(diagonal / spacing) + 2

    # Starting point (offset from center)
    start_offset = -num_lines * spacing / 2

    for i in range(num_lines):
        offset = start_offset + i * spacing

        # Line endpoints (extend beyond bounds)
        p1_x = cx + offset * (-sin_a) - diagonal * cos_a
        p1_y = cy + offset * cos_a - diagonal * sin_a
        p2_x = cx + offset * (-sin_a) + diagonal * cos_a
        p2_y = cy + offset * cos_a + diagonal * sin_a

        line = LineString([(p1_x, p1_y), (p2_x, p2_y)])

        # Clip to polygon
        try:
            clipped = line.intersection(polygon)

            if clipped.is_empty:
                continue

            # Handle different geometry types
            if clipped.geom_type == 'LineString':
                coords = list(clipped.coords)
                if len(coords) >= 2:
                    lines.append((coords[0], coords[-1]))
            elif clipped.geom_type == 'MultiLineString':
                for geom in clipped.geoms:
                    coords = list(geom.coords)
                    if len(coords) >= 2:
                        lines.append((coords[0], coords[-1]))
        except Exception:
            continue

    return lines


def benchmark_shapely(svg_path: str, spacing: float = 2.5, angle: float = 45.0):
    """Run the full benchmark."""
    print(f"Loading: {svg_path}")

    # Load polygons
    load_start = time.perf_counter()
    polygons = svg_to_polygons(svg_path)
    load_time = time.perf_counter() - load_start
    print(f"Loaded {len(polygons)} polygons in {load_time*1000:.1f}ms")

    # Generate hatch fills
    print(f"Generating lines fill (spacing={spacing}, angle={angle})...")

    gen_start = time.perf_counter()
    total_lines = 0

    for i, poly in enumerate(polygons):
        lines = generate_hatch_lines(poly, spacing, angle)
        total_lines += len(lines)

        # Progress indicator for long runs
        if (i + 1) % 50 == 0:
            elapsed = time.perf_counter() - gen_start
            print(f"  Progress: {i+1}/{len(polygons)} polygons, {elapsed:.1f}s elapsed")

    gen_time = time.perf_counter() - gen_start

    print()
    print("=" * 50)
    print("RESULTS (Python + Shapely)")
    print("=" * 50)
    print(f"Polygons:        {len(polygons)}")
    print(f"Lines generated: {total_lines}")
    print(f"Load time:       {load_time*1000:.1f}ms")
    print(f"Generation time: {gen_time*1000:.1f}ms")
    print(f"TOTAL TIME:      {(load_time + gen_time)*1000:.1f}ms ({load_time + gen_time:.2f}s)")
    print("=" * 50)

    return load_time + gen_time


if __name__ == "__main__":
    svg_path = sys.argv[1] if len(sys.argv) > 1 else "test_assets/essex.svg"

    if not Path(svg_path).exists():
        print(f"Error: {svg_path} not found")
        print("Usage: python benchmark_shapely.py [svg_file]")
        sys.exit(1)

    benchmark_shapely(svg_path)
</code></pre>
            </div>

            <div class="step">
                <h3>Run Both Benchmarks</h3>
<pre><code># From the rat-king repository root:

# Python/Shapely benchmark
python benchmark_shapely.py test_assets/essex.svg

# rat-king benchmark
./crates/target/release/rat-king benchmark test_assets/essex.svg -p lines</code></pre>
            </div>

            <div class="step">
                <h3>Compare Results</h3>
                <p>Record the total time from each benchmark and calculate the speedup:</p>
<pre><code>Speedup = Python_time / Rust_time

Example:
  Python: 32,000ms
  Rust:      159ms
  Speedup: 32000 / 159 = 201x</code></pre>
            </div>
        </div>

        <h2>Why the Difference?</h2>

        <div class="card">
            <h3>Shapely Overhead</h3>
            <ul>
                <li><strong>GEOS library calls:</strong> Each <code>intersection()</code> crosses Python/C boundary</li>
                <li><strong>Object allocation:</strong> Creates new geometry objects for each operation</li>
                <li><strong>General-purpose:</strong> Handles arbitrary geometry types, not optimized for lines</li>
                <li><strong>GIL contention:</strong> Single-threaded due to Python's Global Interpreter Lock</li>
            </ul>

            <h3>rat-king Optimizations</h3>
            <ul>
                <li><strong>Custom ray-casting:</strong> Line-polygon clipping without full geometry engine</li>
                <li><strong>Zero allocations:</strong> Reuses buffers, stack-allocated points</li>
                <li><strong>Inlined hot paths:</strong> Critical loops compiled to tight machine code</li>
                <li><strong>Cache-friendly:</strong> Contiguous memory layout for polygon vertices</li>
                <li><strong>SIMD potential:</strong> Compiler auto-vectorizes where possible</li>
            </ul>
        </div>

        <h2>Additional Benchmarks</h2>

        <div class="card">
            <p>Run the full rat-king harness to benchmark all 30 patterns:</p>
<pre><code>./crates/target/release/rat-king harness test_assets/essex.svg --json</code></pre>

            <p>Sample output:</p>
            <table>
                <tr><th>Pattern</th><th>Lines</th><th>Time</th></tr>
                <tr><td>lines</td><td>14,822</td><td>279ms</td></tr>
                <tr><td>crosshatch</td><td>29,983</td><td>564ms</td></tr>
                <tr><td>zigzag</td><td>155,947</td><td>28.7s</td></tr>
                <tr><td>hilbert</td><td>482,961</td><td>1.9s</td></tr>
                <tr><td>concentric</td><td>5,152,309</td><td>71ms</td></tr>
            </table>
        </div>

        <h2>Caveats & Fair Comparison Notes</h2>

        <div class="warning">
            The Python implementation above is a <strong>straightforward</strong> implementation, not heavily optimized.
            A NumPy-vectorized or Cython version could be 5-10x faster. However, this represents typical
            "reach for Shapely" code that most developers write.
        </div>

        <div class="card">
            <h3>Factors that affect results:</h3>
            <ul>
                <li><strong>Polygon complexity:</strong> More vertices = more clipping work</li>
                <li><strong>Spacing:</strong> Smaller spacing = more lines = longer time</li>
                <li><strong>Python version:</strong> 3.11+ has faster interpreter</li>
                <li><strong>Shapely version:</strong> 2.0+ uses vectorized operations</li>
                <li><strong>Hardware:</strong> Apple Silicon shows larger speedups due to memory bandwidth</li>
                <li><strong>First run:</strong> Rust binary may need disk cache warm-up</li>
            </ul>

            <h3>What we're NOT claiming:</h3>
            <ul>
                <li>Shapely is slow (it's excellent for general geometry)</li>
                <li>Python is always 200x slower (this is a specific workload)</li>
                <li>Our clipping is more accurate (Shapely handles edge cases better)</li>
            </ul>
        </div>

        <h2>Run Your Own Test</h2>

        <div class="card">
            <p>Test with your own SVG:</p>
<pre><code># Python
python benchmark_shapely.py your_file.svg

# rat-king
./crates/target/release/rat-king benchmark your_file.svg -p lines

# Or test specific pattern
./crates/target/release/rat-king benchmark your_file.svg -p crosshatch</code></pre>
        </div>

        <div class="footer">
            <p>
                <strong>rat-king</strong> -
                <a href="https://github.com/dirtybirdnj/rat-king">GitHub</a> |
                Generated: <span id="date"></span>
            </p>
            <p>
                Benchmark methodology inspired by
                <a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/">The Computer Language Benchmarks Game</a>
            </p>
        </div>
    </div>

    <script>
        document.getElementById('date').textContent = new Date().toLocaleDateString();
    </script>
</body>
</html>
